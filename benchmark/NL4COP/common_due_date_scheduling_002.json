{
  "problem_id": "common_due_date_scheduling_002",
  "metadata": {
    "problem_type": "Single Machine Common Due Date Scheduling Problem",
    "difficulty": "medium"
  },
  "problem_description": "A small custom manufacturing workshop needs to plan the production sequence for a batch of 10 unique client orders on its single production line. Each order has a specific processing time and associated penalties if it's completed either too early or too late relative to a target completion date. The workshop aims to minimize the total penalty cost. The target date is calculated as 60% of the total time required to process all orders. For each order, if it finishes before this target date, an earliness penalty is incurred; if it finishes after, a tardiness penalty applies. The list below details the 10 orders with their processing times (in hours) and penalty coefficients (Cost/hour): 1. Order 1: Process 20h, Early Penalty $4/h, Late Penalty $5/h; 2. Order 2: Process 6h, Early Penalty $1/h, Late Penalty $15/h; 3. Order 3: Process 13h, Early Penalty $5/h, Late Penalty $13/h; 4. Order 4: Process 13h, Early Penalty $2/h, Late Penalty $13/h; 5. Order 5: Process 12h, Early Penalty $7/h, Late Penalty $6/h; 6. Order 6: Process 12h, Early Penalty $9/h, Late Penalty $8/h; 7. Order 7: Process 12h, Early Penalty $5/h, Late Penalty $15/h; 8. Order 8: Process 3h, Early Penalty $6/h, Late Penalty $1/h; 9. Order 9: Process 12h, Early Penalty $6/h, Late Penalty $8/h; 10. Order 10: Process 13h, Early Penalty $10/h, Late Penalty $1/h. The overall goal is to determine the optimal sequence to process these 10 orders to minimize the total penalty cost, considering the dynamically calculated target completion date.",
  "solution_format_description": "Print the following fields: - order_sequence: optimal production order for orders. - total_cost: total penalty cost for the schedule.",
  "structured_data": {
    "orders": [
      [20, 4, 5],
      [6, 1, 15],
      [13, 5, 13],
      [13, 2, 13],
      [12, 7, 6],
      [12, 9, 8],
      [12, 5, 15],
      [3, 6, 1],
      [12, 6, 8],
      [13, 10, 1]
    ],
    "target_date_factor": 0.6
  },
  "reference_solution": {
    "order_sequence": [4, 2, 1, 3, 7, 6, 9, 5, 8, 10],
    "total_cost": 862.8
  },
  "solver_code": "from cpmpy import *\nimport json\n\norders = [[20, 4, 5], [6, 1, 15], [13, 5, 13], [13, 2, 13], [12, 7, 6], [12, 9, 8], [12, 5, 15], [3, 6, 1], [12, 6, 8], [13, 10, 1]]\ntarget_date_factor = 0.6\n\nnum_orders = len(orders)\n\nprocessing_times = [order[0] for order in orders]\nearliness_penalties = [order[1] for order in orders]\ntardiness_penalties = [order[2] for order in orders]\n\ntotal_processing_time = sum(processing_times)\nscale = 10\nd = int(total_processing_time * target_date_factor * scale)\n\norder_sequence = intvar(1, num_orders, shape=num_orders)\n\nmodel = Model()\n\nmodel += AllDifferent(order_sequence)\n\ntotal_penalty = intvar(0, 100000)\n\ncumulative_time_vars = [intvar(0, total_processing_time * scale) for _ in range(num_orders)]\npenalty_terms = []\n\nfor i in range(num_orders):\n    if i == 0:\n        order_id_at_pos_0 = order_sequence[0] - 1\n        processing_time_at_pos_0 = Element(processing_times, order_id_at_pos_0)\n        model += (cumulative_time_vars[0] == processing_time_at_pos_0 * scale)\n    else:\n        order_id_at_pos_i = order_sequence[i] - 1\n        processing_time_at_pos_i = Element(processing_times, order_id_at_pos_i)\n        model += (cumulative_time_vars[i] == cumulative_time_vars[i-1] + processing_time_at_pos_i * scale)\n    \n    order_id_at_pos_i = order_sequence[i] - 1\n    \n    earliness_coeff_at_pos_i = Element(earliness_penalties, order_id_at_pos_i)\n    tardiness_coeff_at_pos_i = Element(tardiness_penalties, order_id_at_pos_i)\n    \n    earliness_component = intvar(0, 10000)\n    tardiness_component = intvar(0, 10000)\n    \n    diff_earliness_helper = intvar(-total_processing_time * scale, total_processing_time * scale)\n    model += (diff_earliness_helper == d - cumulative_time_vars[i])\n    model += (earliness_component == earliness_coeff_at_pos_i * Maximum([0, diff_earliness_helper]))\n    \n    diff_tardiness_helper = intvar(-total_processing_time * scale, total_processing_time * scale)\n    model += (diff_tardiness_helper == cumulative_time_vars[i] - d)\n    model += (tardiness_component == tardiness_coeff_at_pos_i * Maximum([0, diff_tardiness_helper]))\n    \n    penalty_term = intvar(0, 20000)\n    model += (penalty_term == earliness_component + tardiness_component)\n    penalty_terms.append(penalty_term)\n\nmodel += (total_penalty == sum(penalty_terms))\n\nmodel.minimize(total_penalty)\n\nif model.solve():\n    solution_sequence = [order_sequence[i].value() for i in range(num_orders)]\n    \n    cumulative_time = 0\n    total_cost = 0\n    \n    for i, order_id in enumerate(solution_sequence):\n        order_idx = order_id - 1\n        processing_time = processing_times[order_idx]\n        earliness_penalty = earliness_penalties[order_idx]\n        tardiness_penalty = tardiness_penalties[order_idx]\n        \n        cumulative_time += processing_time\n        \n        target_date = total_processing_time * target_date_factor\n        earliness = max(0, target_date - cumulative_time)\n        tardiness = max(0, cumulative_time - target_date)\n        \n        early_cost = earliness * earliness_penalty\n        late_cost = tardiness * tardiness_penalty\n        total_cost += early_cost + late_cost\n    \n    result = {\n        \"order_sequence\": solution_sequence,\n        \"total_cost\": total_cost\n    }\n    print(json.dumps(result))\nelse:\n    print(\"No solution found\")",
  "evaluation_function": "def evaluate(candidate_solution, structured_data, reference_solution):\n    import json\n\n    try:\n        solution = json.loads(candidate_solution) if isinstance(candidate_solution, str) else candidate_solution\n    except:\n        return {\"is_valid\": False, \"validation_errors\": [\"Invalid JSON format\"], \"optimality_score\": 0.0}\n\n    if not solution or \"order_sequence\" not in solution:\n        return {\"is_valid\": False, \"validation_errors\": [\"Missing required field: 'order_sequence'\"], \"optimality_score\": 0.0}\n\n    try:\n        order_sequence = solution[\"order_sequence\"]\n        orders_data = structured_data[\"orders\"]\n        \n        num_orders = len(orders_data)\n        errors = []\n\n        if len(order_sequence) != num_orders:\n            errors.append(f\"Invalid sequence length: expected {num_orders}, got {len(order_sequence)}\")\n            return {\"is_valid\": False, \"validation_errors\": errors, \"optimality_score\": 0.0}\n\n        expected_set = set(range(1, num_orders + 1))\n        actual_set = set(order_sequence)\n        if actual_set != expected_set:\n             missing = expected_set - actual_set\n             extra = actual_set - expected_set\n             if missing:\n                 errors.append(f\"Missing order IDs: {sorted(list(missing))}\")\n             if extra:\n                 errors.append(f\"Extra order IDs: {sorted(list(extra))}\")\n             return {\"is_valid\": False, \"validation_errors\": errors, \"optimality_score\": 0.0}\n\n        if \"total_cost\" in solution:\n            total_candidate_penalty = solution[\"total_cost\"]\n        else:\n            return {\"is_valid\": False, \"validation_errors\": [\"Missing required field: 'total_cost'\"], \"optimality_score\": 0.0}\n\n        total_reference_penalty = reference_solution[\"total_cost\"]\n\n        if total_reference_penalty == 0:\n            if total_candidate_penalty == 0:\n                optimality_score = 1.0\n            else:\n                optimality_score = 0.0 \n        else:\n            gap = abs(total_candidate_penalty - total_reference_penalty) / abs(total_reference_penalty)\n            optimality_score = max(0, 1 - gap)\n\n        is_valid = (len(errors) == 0)\n        return {\n            \"is_valid\": is_valid,\n            \"validation_errors\": errors,\n            \"optimality_score\": optimality_score\n        }\n\n    except Exception as e:\n        return {\"is_valid\": False, \"validation_errors\": [f\"Format error in solution data or an unexpected error occurred during evaluation: {str(e)}\"], \"optimality_score\": 0.0}"
}