{ 
  "problem_id": "capacitated_warehouse_location_002", 
  "metadata": { 
    "problem_type": "Capacitated Warehouse Location Problem", 
    "difficulty": "medium" 
  }, 
  "problem_description": "A retail company is planning to optimize its distribution network to serve seven major stores in the region. The company has three potential distribution centers to choose from, each with different setup costs and storage capacities. Each store has specific monthly demand in tons, and the transportation costs vary depending on which distribution center supplies them. The company needs to decide which distribution centers to open and how to allocate the store demands among these centers to minimize total costs while ensuring all store demands are fully met and no distribution center exceeds its capacity.\n\nThe available distribution centers and their characteristics are:\n1. Distribution Center A: Setup cost $1200, capacity 180 tons\n2. Distribution Center B: Setup cost $650, capacity 95 tons  \n3. Distribution Center C: Setup cost $1850, capacity 220 tons\n\nThe monthly demands and transportation costs (per ton) from each distribution center to each store are:\n1. Store 1: Demand 75 tons, transportation costs [$23, $8, $31] from centers A, B, C respectively\n2. Store 2: Demand 42 tons, transportation costs [$15, $27, $12] from centers A, B, C respectively\n3. Store 3: Demand 88 tons, transportation costs [$9, $33, $19] from centers A, B, C respectively\n4. Store 4: Demand 56 tons, transportation costs [$28, $14, $22] from centers A, B, C respectively\n5. Store 5: Demand 63 tons, transportation costs [$17, $25, $8] from centers A, B, C respectively\n6. Store 6: Demand 91 tons, transportation costs [$32, $11, $26] from centers A, B, C respectively\n7. Store 7: Demand 37 tons, transportation costs [$13, $29, $16] from centers A, B, C respectively\n\nEach store's demand must be completely satisfied, and the total demand allocated to any distribution center cannot exceed its capacity. The company wants to find the most cost-effective plan that minimizes the sum of setup costs and transportation costs.", 
  "solution_format_description": "Print the following fields: - total_cost: total cost including setup and transportation. - distribution_centers_open: which distribution centers are open. - allocations: how much each store orders from each distribution center.", 
  "structured_data": { 
    "warehouse_capacities": [180, 95, 220], 
    "warehouse_setup_costs": [1200, 650, 1850], 
    "store_demands": [75, 42, 88, 56, 63, 91, 37], 
    "transportation_costs": [ 
      [23, 8, 31], 
      [15, 27, 12], 
      [9, 33, 19], 
      [28, 14, 22], 
      [17, 25, 8], 
      [32, 11, 26], 
      [13, 29, 16] 
    ] 
  }, 
  "reference_solution": { 
    "total_cost": 9879, 
    "distribution_centers_open": [1, 1, 1], 
    "allocations": [[12, 63, 0], [0, 0, 42], [88, 0, 0], [0, 0, 56], [0, 0, 63], [0, 32, 59], [37, 0, 0]] 
  }, 
  "solver_code": "from cpmpy import *\nimport json\n\nwarehouse_capacities = [180, 95, 220]\nwarehouse_setup_costs = [1200, 650, 1850]\nstore_demands = [75, 42, 88, 56, 63, 91, 37]\ntransportation_costs = [\n    [23, 8, 31],\n    [15, 27, 12],\n    [9, 33, 19],\n    [28, 14, 22],\n    [17, 25, 8],\n    [32, 11, 26],\n    [13, 29, 16]\n]\n\nm = len(warehouse_capacities)\nn = len(store_demands)\n\ncapacities = warehouse_capacities\nfixed_costs = warehouse_setup_costs\ndemands = store_demands\ncosts = transportation_costs\n\nmodel = Model()\n\ndistribution_center_open = boolvar(shape=m)\nallocations = [intvar(shape=m, lb=0, ub=max(demands)) for _ in range(n)]\n\nfor j in range(n):\n    model += sum(allocations[j]) == demands[j]\n\nfor j in range(n):\n    for i in range(m):\n        model += allocations[j][i] <= demands[j] * distribution_center_open[i]\n\nfor i in range(m):\n    model += sum(allocations[j][i] for j in range(n)) <= capacities[i] * distribution_center_open[i]\n\ntotal_cost = sum(fixed_costs[i] * distribution_center_open[i] for i in range(m))\ntotal_cost += sum(allocations[j][i] * costs[j][i] for j in range(n) for i in range(m))\n\nmodel.minimize(total_cost)\n\nif model.solve():\n    result = {\n        \"total_cost\": total_cost.value(),\n        \"distribution_centers_open\": [int(distribution_center_open[i].value()) for i in range(m)],\n        \"allocations\": [[allocations[j][i].value() for i in range(m)] for j in range(n)]\n    }\n    print(json.dumps(result))\nelse:\n    print(\"No solution found\")",
  "evaluation_function": "def evaluate(candidate_solution, structured_data, reference_solution):\n    import json\n    \n    try:\n        solution = json.loads(candidate_solution) if isinstance(candidate_solution, str) else candidate_solution\n    except:\n        return {\"is_valid\": False, \"validation_errors\": [\"Invalid JSON format\"], \"optimality_score\": 0.0}\n    \n    required_fields = [\"total_cost\", \"distribution_centers_open\", \"allocations\"]\n    missing = [f for f in required_fields if solution is None or f not in solution]\n    if missing:\n        return {\"is_valid\": False, \"validation_errors\": [f\"Missing fields: {missing}\"], \"optimality_score\": 0.0}\n    \n    try:\n        total_cost = solution[\"total_cost\"]\n        distribution_centers_open = solution[\"distribution_centers_open\"]\n        allocations = solution[\"allocations\"]\n        distribution_centers = structured_data[\"distribution_centers\"]\n        stores = structured_data[\"stores\"]\n        errors = []\n        \n        m = len(distribution_centers)\n        n = len(stores)\n        \n        if len(distribution_centers_open) != m:\n            errors.append(f\"distribution_centers_open length mismatch: expected {m}, got {len(distribution_centers_open)}\")\n        \n        if len(allocations) != n:\n            errors.append(f\"allocations length mismatch: expected {n}, got {len(allocations)}\")\n        \n        for i in range(n):\n            if len(allocations[i]) != m:\n                errors.append(f\"allocations[{i}] length mismatch: expected {m}, got {len(allocations[i])}\")\n        \n        for i in range(m):\n            if distribution_centers_open[i] not in [0, 1]:\n                errors.append(f\"distribution_centers_open[{i}] must be 0 or 1, got {distribution_centers_open[i]}\")\n        \n        calculated_total_cost = 0\n        \n        for i in range(m):\n            if distribution_centers_open[i] == 1:\n                calculated_total_cost += distribution_centers[i][\"setup_cost\"]\n        \n        for j in range(n):\n            store_demand = stores[j][\"demand\"]\n            allocated_amount = sum(allocations[j])\n            \n            if abs(allocated_amount - store_demand) > 1e-6:\n                errors.append(f\"Store {j} demand violation: allocated {allocated_amount}, required {store_demand}\")\n            \n            for i in range(m):\n                allocation = allocations[j][i]\n                \n                if allocation < 0:\n                    errors.append(f\"Negative allocation: store {j}, distribution center {i}: {allocation}\")\n                \n                if allocation > 0 and distribution_centers_open[i] != 1:\n                    errors.append(f\"Allocation to closed distribution center: store {j}, distribution center {i}: {allocation}\")\n                \n                calculated_total_cost += allocation * stores[j][\"transportation_costs\"][i]\n        \n        for i in range(m):\n            total_allocated = sum(allocations[j][i] for j in range(n))\n            if distribution_centers_open[i] == 1 and total_allocated > distribution_centers[i][\"capacity\"] + 1e-6:\n                excess = total_allocated - distribution_centers[i][\"capacity\"]\n                errors.append(f\"Distribution center {i} capacity exceeded by {excess}\")\n        \n        if abs(calculated_total_cost - total_cost) > 1e-6:\n            errors.append(f\"Cost inconsistency: calculated {calculated_total_cost}, declared {total_cost}\")\n        \n        if len(errors) > 0:\n            optimality_score = 0.0\n        else:\n            optimal_cost = reference_solution[\"total_cost\"]\n            if optimal_cost == 0:\n                optimality_score = 1.0 if total_cost == 0 else 0.0\n            else:\n                gap = abs(optimal_cost - total_cost) / abs(optimal_cost)\n                optimality_score = max(0, 1 - gap)\n        \n        return {\n            \"is_valid\": len(errors) == 0,\n            \"validation_errors\": errors,\n            \"optimality_score\": optimality_score\n        }\n        \n    except Exception as e:\n        return {\"is_valid\": False, \"validation_errors\": [\"Format error in solution data\"], \"optimality_score\": 0.0}" 
} 
