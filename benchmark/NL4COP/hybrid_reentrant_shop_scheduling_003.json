{
  "problem_id": "hybrid_reentrant_shop_scheduling_003",
  "metadata": {
    "problem_type": "Hybrid Reentrant Shop Scheduling Problem",
    "difficulty": "hard"
  },
  "problem_description": "A medium-sized architectural firm operates with two senior design partners who must collectively oversee the complete design development process for ten distinct building projects, labeled as Projects A through J. Each project necessitates a comprehensive three-phase design methodology that ensures architectural integrity and client satisfaction throughout the development lifecycle. The initial conceptual design phase requires exactly one week of intensive design thinking and preliminary sketching, during which each project must be assigned to whichever senior partner becomes available first, with the determination of project-partner assignments emerging naturally from the sequential arrival of client commissions and the current workload distribution across the firm's design leadership. Upon achieving conceptual design completion, every project must transition to the firm's singular specialized building code compliance workstation for detailed regulatory review and permit preparation, where the duration of this critical phase varies considerably based on project complexity: Project A requires 34 weeks for comprehensive code analysis, Project B needs 7 weeks, Project C demands 21 weeks, Project D requires 25 weeks, Project E needs 32 weeks, Project F necessitates 13 weeks, Project G requires 12 weeks, Project H needs 14 weeks, Project I demands 29 weeks, and Project J requires 15 weeks. The building code compliance workstation maintains absolute exclusivity in its operations, accommodating only one project at any given moment, which creates a sequential bottleneck that necessitates careful strategic planning regarding the optimal ordering of projects through this phase. Following successful completion of the regulatory compliance phase, each project must return to the identical senior partner who originally managed its initial conceptual design for the final construction documentation and client presentation phase, with the time investment for this concluding stage reflecting the unique design challenges and client requirements of each project: Project A requires 58 weeks for final documentation, Project B needs 51 weeks, Project C demands 21 weeks, Project D requires 26 weeks, Project E necessitates 30 weeks, Project F needs 21 weeks, Project G requires 56 weeks, Project H demands 60 weeks, Project I needs 48 weeks, and Project J necessitates 34 weeks. The senior design partners cannot simultaneously engage with multiple projects during either the initial conceptual phase or the final documentation phase, and each project must fully complete its current phase before progressing to the subsequent phase of development. The firm's management seeks to determine the optimal sequencing strategy that minimizes the total time required to complete all ten projects while ensuring that each project receives appropriate attention from its designated senior partner throughout both the initial and final phases of the design process.",
  "solution_format_description": "Print the following fields: - compliance_sequence: processing order for projects at compliance workstation. - total_design_time: total time to complete all designs.",
  "structured_data": {
    "num_projects": 10,
    "num_partners": 2,
    "conceptual_design_time": 1,
    "compliance_review_times": [34, 7, 21, 25, 32, 13, 12, 14, 29, 15],
    "final_documentation_times": [58, 51, 21, 26, 30, 21, 56, 60, 48, 34]
  },
  "reference_solution": {
    "compliance_sequence": [2, 8, 9, 7, 6, 5, 1, 10, 4, 3],
    "total_design_time": 224
  },
  "solver_code": "from cpmpy import *\nimport json\n\nnum_projects = 10\nnum_partners = 2\nconceptual_design_time = 1\ncompliance_review_times = [34, 7, 21, 25, 32, 13, 12, 14, 29, 15]\nfinal_documentation_times = [58, 51, 21, 26, 30, 21, 56, 60, 48, 34]\n\nhorizon = conceptual_design_time * num_projects + sum(compliance_review_times) + sum(final_documentation_times)\n\nmodel = Model()\n\npermutation = intvar(1, num_projects, shape=num_projects)\nmodel += AllDifferent(permutation)\n\npartner_assignment = intvar(1, num_partners, shape=num_projects)\n\nconceptual_start = intvar(0, horizon, shape=num_projects)\nconceptual_end = intvar(0, horizon, shape=num_projects)\ncompliance_start = intvar(0, horizon, shape=num_projects)\ncompliance_end = intvar(0, horizon, shape=num_projects)\ndocumentation_start = intvar(0, horizon, shape=num_projects)\ndocumentation_end = intvar(0, horizon, shape=num_projects)\n\nfor i in range(num_projects):\n    model += conceptual_end[i] == conceptual_start[i] + conceptual_design_time\n    model += compliance_end[i] == compliance_start[i] + compliance_review_times[i]\n    model += documentation_end[i] == documentation_start[i] + final_documentation_times[i]\n    model += conceptual_start[i] >= 0\n    model += compliance_start[i] >= conceptual_end[i]\n    model += documentation_start[i] >= compliance_end[i]\n\nfor partner in range(1, num_partners + 1):\n    for i in range(num_projects):\n        for j in range(i + 1, num_projects):\n            model += ((partner_assignment[i] == partner) & (partner_assignment[j] == partner)).implies(\n                (conceptual_start[i] >= conceptual_end[j]) | (conceptual_start[j] >= conceptual_end[i])\n            )\n\nfor pos in range(num_projects - 1):\n    current_job = permutation[pos] - 1  \n    next_job = permutation[pos + 1] - 1\n    \n    model += compliance_start[next_job] >= compliance_end[current_job]\n\nfor partner in range(1, num_partners + 1):\n    for i in range(num_projects):\n        for j in range(i + 1, num_projects):\n            model += ((partner_assignment[i] == partner) & (partner_assignment[j] == partner)).implies(\n                (documentation_start[i] >= documentation_end[j]) | (documentation_start[j] >= documentation_end[i])\n            )\n\nmakespan = intvar(0, horizon)\nmodel += makespan == max(documentation_end)\nmodel.minimize(makespan)\n\nif model.solve(time_limit=30):\n    permutation_vals = [int(permutation[i].value()) for i in range(num_projects)]\n    total_design_time = int(makespan.value())\n    \n    result = {\n        \"compliance_sequence\": permutation_vals,\n        \"total_design_time\": total_design_time\n    }\n    print(json.dumps(result))\nelse:\n    result = {\n        \"compliance_sequence\": list(range(1, num_projects + 1)),\n        \"total_design_time\": sum(compliance_review_times) + sum(final_documentation_times) + num_projects * conceptual_design_time\n    }\n    print(json.dumps(result))",
  "evaluation_function": "def evaluate(candidate_solution, structured_data, reference_solution):\n    import json\n    \n    try:\n        solution = json.loads(candidate_solution) if isinstance(candidate_solution, str) else candidate_solution\n    except:\n        return {\"is_valid\": False, \"validation_errors\": [\"Invalid JSON format\"], \"optimality_score\": 0.0}\n    \n    required_fields = [\"compliance_sequence\", \"total_design_time\"]\n    missing = [f for f in required_fields if solution is None or f not in solution]\n    if missing:\n        return {\"is_valid\": False, \"validation_errors\": [f\"Missing fields: {missing}\"], \"optimality_score\": 0.0}\n    \n    try:\n        compliance_sequence = solution[\"compliance_sequence\"]\n        total_design_time = solution[\"total_design_time\"]\n        num_projects = structured_data[\"num_projects\"]\n        errors = []\n        \n        if len(compliance_sequence) != num_projects:\n            errors.append(f\"Sequence length mismatch: expected {num_projects}, got {len(compliance_sequence)}\")\n        \n        if sorted(compliance_sequence) != list(range(1, num_projects + 1)):\n            errors.append(\"Invalid permutation: sequence must contain all projects from 1 to n exactly once\")\n        \n        if len(errors) > 0:\n            optimality_score = 0.0\n        else:\n            optimal_time = reference_solution[\"total_design_time\"]\n            if optimal_time == 0:\n                optimality_score = 1.0 if total_design_time == 0 else 0.0\n            else:\n                gap = abs(optimal_time - total_design_time) / abs(optimal_time)\n                optimality_score = max(0, 1 - gap)\n        \n        return {\n            \"is_valid\": len(errors) == 0,\n            \"validation_errors\": errors,\n            \"optimality_score\": optimality_score\n        }\n        \n    except Exception:\n        return {\"is_valid\": False, \"validation_errors\": [\"Format error in solution data\"], \"optimality_score\": 0.0}"
}